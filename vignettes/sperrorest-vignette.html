<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Alexander Brenning, Patrick Schratz" />

<meta name="date" content="2016-12-11" />

<title>sperrorest-vignette: Spatial modeling using statistical learning techniques</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">sperrorest-vignette: Spatial modeling using statistical learning techniques</h1>
<h4 class="author"><em>Alexander Brenning, Patrick Schratz</em></h4>
<h4 class="date"><em>2016-12-11</em></h4>


<div id="TOC">
<ul>
<li><a href="#data-and-packages">Data And Packages</a></li>
<li><a href="#preprocessing">Preprocessing</a></li>
<li><a href="#modeling">Modeling</a><ul>
<li><a href="#linear-discriminant-analysis-lda">Linear Discriminant Analysis (LDA)</a></li>
<li><a href="#classification-tree">Classification Tree</a></li>
<li><a href="#bagging-ipred">Bagging (ipred)</a></li>
</ul></li>
<li><a href="#cross-validation-estimation-of-predictive-performance">Cross-Validation Estimation of Predictive Performance</a><ul>
<li><a href="#linear-discriminant-analysis-lda-1">Linear Discriminant Analysis (LDA)</a></li>
<li><a href="#bagging">Bagging</a></li>
</ul></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<div id="data-and-packages" class="section level1">
<h1>Data And Packages</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rpart)
<span class="kw">library</span>(MASS)
<span class="kw">library</span>(ipred)
<span class="kw">library</span>(sperrorest)</code></pre></div>
<p>The <code>maipo</code> data set from Marco Pena is used.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&quot;maipo&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sperrorest&quot;</span>)</code></pre></div>
<p>Variable description:</p>
<p><strong>Response</strong><br />
- <code>croptype</code>: response variable (factor) with 4 levels</p>
<p><strong>Predictors</strong><br />
- <code>b</code>[12-87]: spectral data, e.g.Â b82 = image date #8, spectral band #2<br />
- <code>ndvi</code>[01-08]: Normalized Differenced Vegetation Index, e.g. #8 = image date #8<br />
- <code>ndwi</code>[01-08]: Normalized Differenced Water Index, e.g. #8 = image date #8</p>
<p><strong>Others</strong><br />
- <code>field</code>: field identifier (grouping variable - not to be used as predictor)<br />
- <code>utmx</code>, <code>utmy</code>: x/y location; not to be used as predictors</p>
</div>
<div id="preprocessing" class="section level1">
<h1>Preprocessing</h1>
<p>Transformation of some predictor variables:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predictors &lt;-<span class="st"> </span><span class="kw">colnames</span>(maipo)[<span class="dv">5</span>:<span class="kw">ncol</span>(maipo)]
<span class="co"># Construct a formula:</span>
fo &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(<span class="st">&quot;croptype ~&quot;</span>, <span class="kw">paste</span>(predictors, <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>)))</code></pre></div>
<p>Quick look at (some) correlations among the predictors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">co &lt;-<span class="st"> </span><span class="kw">abs</span>(<span class="kw">cor</span>(maipo[, predictors]) *<span class="st"> </span><span class="dv">100</span>)
co[co &lt;<span class="st"> </span><span class="dv">70</span>] &lt;-<span class="st"> </span><span class="dv">0</span> <span class="co"># mask out weak/moderate correlations</span>
<span class="kw">head</span>(<span class="kw">round</span>(co))
##     b12 b13 b14 b15 b16 b17 b22 b23 b24 b25 b26 b27 b32 b33 b34 b35 b36
## b12 100  97  98   0   0  84  81  81  79   0   0  70   0   0   0   0   0
## b13  97 100  96   0   0  75  79  83  78   0   0   0   0   0   0   0   0
## b14  98  96 100   0  72  87  80  82  82   0   0  75   0   0   0   0   0
## b15   0   0   0 100   0   0   0   0   0   0   0   0   0   0   0   0   0
## b16   0   0  72   0 100  94   0   0   0   0  89  82   0   0   0   0   0
## b17  84  75  87   0  94 100   0   0  72   0  83  86   0   0   0   0   0
##     b37 b42 b43 b44 b45 b46 b47 b52 b53 b54 b55 b56 b57 b62 b63 b64 b65
## b12   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0
## b13   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0
## b14   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0
## b15   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0
## b16   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0
## b17   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0   0
##     b66 b67 b72 b73 b74 b75 b76 b77 b82 b83 b84 b85 b86 b87 ndvi01 ndvi02
## b12   0   0   0   0   0   0   0   0   0   0   0   0   0   0     92     77
## b13   0   0   0   0   0   0   0   0   0   0   0   0   0   0     83     72
## b14   0   0   0   0   0   0   0   0   0   0   0   0   0   0     93     79
## b15   0   0   0   0   0   0   0   0   0   0   0   0   0   0     75      0
## b16   0   0   0   0   0   0   0   0   0   0   0   0   0   0      0      0
## b17   0   0   0   0   0   0   0   0   0   0   0   0   0   0     85     73
##     ndvi03 ndvi04 ndvi05 ndvi06 ndvi07 ndvi08 ndwi01 ndwi02 ndwi03 ndwi04
## b12      0      0      0      0      0      0     74      0      0      0
## b13      0      0      0      0      0      0      0      0      0      0
## b14      0      0      0      0      0      0     78      0      0      0
## b15      0      0      0      0      0      0     74      0      0      0
## b16      0      0      0      0      0      0     85     77      0      0
## b17      0      0      0      0      0      0     94     82      0      0
##     ndwi05 ndwi06 ndwi07 ndwi08
## b12      0      0      0      0
## b13      0      0      0      0
## b14      0      0      0      0
## b15      0      0      0      0
## b16      0      0      0      0
## b17      0      0      0      0</code></pre></div>
</div>
<div id="modeling" class="section level1">
<h1>Modeling</h1>
<div id="linear-discriminant-analysis-lda" class="section level2">
<h2>Linear Discriminant Analysis (LDA)</h2>
<p>Fit a model with all predictors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">lda</span>(fo, <span class="dt">data =</span> maipo)</code></pre></div>
<p>Predict the croptype with the fitted model and calculate the average misclassification error rate (MER):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newdata =</span> maipo)$class
<span class="kw">mean</span>(pred !=<span class="st"> </span>maipo$croptype)
## [1] 0.04369247</code></pre></div>
<p>Take a look at the confusion matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(<span class="dt">pred =</span> pred, <span class="dt">obs =</span> maipo$croptype)
##        obs
## pred    crop1 crop2 crop3 crop4
##   crop1  1294     8     4    37
##   crop2    50  1054     4    44
##   crop3     0     0  1935     6
##   crop4    45   110    29  3093</code></pre></div>
</div>
<div id="classification-tree" class="section level2">
<h2>Classification Tree</h2>
<p>Fit a model with all predictors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">rpart</span>(fo, <span class="dt">data =</span> maipo)
<span class="co">#            control = rpart.control(cp=0.01))</span>

## optional: view the classiciation tree
<span class="co"># par(xpd = TRUE)</span>
<span class="co"># plot(fit)</span>
<span class="co"># text(fit, use.n = TRUE)</span></code></pre></div>
<p>Again, predict the croptype with the fitted model and calculate the average MER:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newdata =</span> maipo, <span class="dt">type =</span> <span class="st">&quot;class&quot;</span>)
<span class="kw">mean</span>(pred !=<span class="st"> </span>maipo$croptype)
## [1] 0.1127966</code></pre></div>
<p>And take a look at the confusion matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(<span class="dt">pred =</span> pred, <span class="dt">obs =</span> maipo$croptype)
##        obs
## pred    crop1 crop2 crop3 crop4
##   crop1  1204    66     0    54
##   crop2    47   871    38   123
##   crop3    38     8  1818    53
##   crop4   100   227   116  2950</code></pre></div>
<p>Note that some classes may be over-/underpredicted, i.e.Â remotely-sensed crop areas can be biased even if accuracy is high!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(pred)
## crop1 crop2 crop3 crop4 
##  1324  1079  1917  3393
<span class="kw">summary</span>(maipo$croptype)
## crop1 crop2 crop3 crop4 
##  1389  1172  1972  3180</code></pre></div>
</div>
<div id="bagging-ipred" class="section level2">
<h2>Bagging (ipred)</h2>
<p>The same can be done using the <code>bagging()</code> function from the <code>ipred</code> package <span class="citation">(Leo Breiman, 1996)</span>. This is a previous version of the famous <code>randomForest()</code> by Leo Breiman <span class="citation">(L. Breiman, 2001)</span>. For some reason <code>randomForest()</code> does introduce problems when being paralized. Hence <code>bagging()</code> is used in this vignette. However, <code>randomForest()</code> works fine with the sequential <code>sperrorest()</code> function and should be prefered over <code>bagging()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw">bagging</span>(fo, <span class="dt">data =</span> maipo, <span class="dt">coob =</span> <span class="ot">TRUE</span>)
fit
## 
## Bagging classification trees with 25 bootstrap replications 
## 
## Call: bagging.data.frame(formula = fo, data = maipo, coob = TRUE)
## 
## Out-of-bag estimate of misclassification error:  0.0196</code></pre></div>
<p>Training-set misclassification error rate (MER)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred &lt;-<span class="st"> </span><span class="kw">predict</span>(fit, <span class="dt">newdata =</span> maipo, <span class="dt">type =</span> <span class="st">&quot;class&quot;</span>)
<span class="kw">mean</span>(pred !=<span class="st"> </span>maipo$croptype)
## [1] 0</code></pre></div>
<p>Confusion matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(<span class="dt">pred =</span> pred, <span class="dt">obs =</span> maipo$croptype)
##        obs
## pred    crop1 crop2 crop3 crop4
##   crop1  1389     0     0     0
##   crop2     0  1172     0     0
##   crop3     0     0  1972     0
##   crop4     0     0     0  3180</code></pre></div>
<ul>
<li>Almost no missclassification! (only one observation)</li>
<li>Even the OOB (out-of-bag) estimate of the error rate is &lt; 1%.</li>
<li>Too good to be true? Weâll seeâ¦</li>
</ul>
</div>
</div>
<div id="cross-validation-estimation-of-predictive-performance" class="section level1">
<h1>Cross-Validation Estimation of Predictive Performance</h1>
<div id="linear-discriminant-analysis-lda-1" class="section level2">
<h2>Linear Discriminant Analysis (LDA)</h2>
<p>We need to set up some functions to create a wrapper predict function of the LDA model for <code>sperrorest()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lda.predfun &lt;-<span class="st"> </span>function(object, newdata, <span class="dt">fac =</span> <span class="ot">NULL</span>) {
  <span class="kw">library</span>(nnet)
  majority &lt;-<span class="st"> </span>function(x) {
    <span class="kw">levels</span>(x)[<span class="kw">which.is.max</span>(<span class="kw">table</span>(x))]
  }
  
  majority.filter &lt;-<span class="st"> </span>function(x, fac) {
    for (lev in <span class="kw">levels</span>(fac)) {
      x[ fac ==<span class="st"> </span>lev ] &lt;-<span class="st"> </span><span class="kw">majority</span>(x[ fac ==<span class="st"> </span>lev ])
    }
    x
  }
  
  pred &lt;-<span class="st"> </span><span class="kw">predict</span>(object, <span class="dt">newdata =</span> newdata)$class
  if (!<span class="kw">is.null</span>(fac)) pred &lt;-<span class="st"> </span><span class="kw">majority.filter</span>(pred, newdata[,fac]) 
  <span class="kw">return</span>(pred)
}</code></pre></div>
<p>Finally, we can run <code>sperrorest()</code> with a non-spatial sampling setup (<code>partition.cv()</code>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res.lda.nsp &lt;-<span class="st"> </span>res &lt;-<span class="st"> </span><span class="kw">sperrorest</span>(fo, <span class="dt">data =</span> maipo, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;utmx&quot;</span>,<span class="st">&quot;utmy&quot;</span>), 
                                 <span class="dt">model.fun =</span> lda,
                                 <span class="dt">pred.fun =</span> lda.predfun, 
                                 <span class="dt">pred.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>),
                                 <span class="dt">smp.fun =</span> partition.cv, 
                                 <span class="dt">smp.args =</span> <span class="kw">list</span>(<span class="dt">repetition =</span> <span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nfold =</span> <span class="dv">5</span>),
                                 <span class="dt">error.rep =</span> <span class="ot">TRUE</span>, <span class="dt">error.fold =</span> <span class="ot">FALSE</span>)
## Sun Dec 11 21:03:48 2016 Repetition 1 
## Sun Dec 11 21:03:48 2016 - Fold 1 
## Sun Dec 11 21:03:51 2016 - Fold 2 
## Sun Dec 11 21:03:54 2016 - Fold 3 
## Sun Dec 11 21:03:56 2016 - Fold 4 
## Sun Dec 11 21:03:58 2016 - Fold 5 
## Sun Dec 11 21:04:01 2016 Repetition 2 
## Sun Dec 11 21:04:01 2016 - Fold 1 
## Sun Dec 11 21:04:04 2016 - Fold 2 
## Sun Dec 11 21:04:06 2016 - Fold 3 
## Sun Dec 11 21:04:08 2016 - Fold 4 
## Sun Dec 11 21:04:11 2016 - Fold 5 
## Sun Dec 11 21:04:13 2016 Repetition 3 
## Sun Dec 11 21:04:13 2016 - Fold 1 
## Sun Dec 11 21:04:15 2016 - Fold 2 
## Sun Dec 11 21:04:17 2016 - Fold 3 
## Sun Dec 11 21:04:19 2016 - Fold 4 
## Sun Dec 11 21:04:21 2016 - Fold 5 
## Sun Dec 11 21:04:23 2016 Repetition 4 
## Sun Dec 11 21:04:23 2016 - Fold 1 
## Sun Dec 11 21:04:26 2016 - Fold 2 
## Sun Dec 11 21:04:28 2016 - Fold 3 
## Sun Dec 11 21:04:30 2016 - Fold 4 
## Sun Dec 11 21:04:32 2016 - Fold 5 
## Sun Dec 11 21:04:34 2016 Repetition 5 
## Sun Dec 11 21:04:34 2016 - Fold 1 
## Sun Dec 11 21:04:36 2016 - Fold 2 
## Sun Dec 11 21:04:39 2016 - Fold 3 
## Sun Dec 11 21:04:41 2016 - Fold 4 
## Sun Dec 11 21:04:43 2016 - Fold 5 
## Sun Dec 11 21:04:48 2016 Repetition 6 
## Sun Dec 11 21:04:48 2016 - Fold 1 
## Sun Dec 11 21:04:51 2016 - Fold 2 
## Sun Dec 11 21:04:53 2016 - Fold 3 
## Sun Dec 11 21:04:56 2016 - Fold 4 
## Sun Dec 11 21:04:58 2016 - Fold 5 
## Sun Dec 11 21:05:01 2016 Done.
<span class="kw">round</span>(<span class="kw">summary</span>(res.lda.nsp$error.rep), <span class="dv">3</span>)
##                     mean    sd    median   IQR
## train.error        0.034 0.001     0.034 0.001
## train.accuracy     0.966 0.001     0.966 0.001
## train.events    4688.000 0.000  4688.000 0.000
## train.count    30852.000 0.000 30852.000 0.000
## test.error         0.040 0.002     0.040 0.001
## test.accuracy      0.960 0.002     0.960 0.001
## test.events     1172.000 0.000  1172.000 0.000
## test.count      7713.000 0.000  7713.000 0.000</code></pre></div>
<p>To run a spatial cross-validation at the field level, we can use <code>partition.factor.cv()</code> as the sampling function. Subsequently, we have to specify the location of the fields. We can do so using the <code>field</code> variable of our data set and put in <code>smp.args</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res.lda.sp &lt;-<span class="st"> </span><span class="kw">sperrorest</span>(fo, <span class="dt">data =</span> maipo, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;utmx&quot;</span>,<span class="st">&quot;utmy&quot;</span>), 
                         <span class="dt">model.fun =</span> lda,
                         <span class="dt">pred.fun =</span> lda.predfun, 
                         <span class="dt">pred.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>),
                         <span class="dt">smp.fun =</span> partition.factor.cv,
                         <span class="dt">smp.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>, <span class="dt">repetition =</span> <span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nfold =</span> <span class="dv">5</span>),
                         <span class="dt">error.rep =</span> <span class="ot">TRUE</span>, <span class="dt">error.fold =</span> <span class="ot">FALSE</span>, 
                         <span class="dt">benchmark =</span> <span class="ot">TRUE</span>)
## Sun Dec 11 21:05:01 2016 Repetition 1 
## Sun Dec 11 21:05:01 2016 - Fold 1 
## Sun Dec 11 21:05:05 2016 - Fold 2 
## Sun Dec 11 21:05:07 2016 - Fold 3 
## Sun Dec 11 21:05:09 2016 - Fold 4 
## Sun Dec 11 21:05:11 2016 - Fold 5 
## Sun Dec 11 21:05:14 2016 Repetition 2 
## Sun Dec 11 21:05:14 2016 - Fold 1 
## Sun Dec 11 21:05:16 2016 - Fold 2 
## Sun Dec 11 21:05:19 2016 - Fold 3 
## Sun Dec 11 21:05:22 2016 - Fold 4 
## Sun Dec 11 21:05:24 2016 - Fold 5 
## Sun Dec 11 21:05:26 2016 Repetition 3 
## Sun Dec 11 21:05:26 2016 - Fold 1 
## Sun Dec 11 21:05:30 2016 - Fold 2 
## Sun Dec 11 21:05:32 2016 - Fold 3 
## Sun Dec 11 21:05:35 2016 - Fold 4 
## Sun Dec 11 21:05:37 2016 - Fold 5 
## Sun Dec 11 21:05:40 2016 Repetition 4 
## Sun Dec 11 21:05:40 2016 - Fold 1 
## Sun Dec 11 21:05:42 2016 - Fold 2 
## Sun Dec 11 21:05:44 2016 - Fold 3 
## Sun Dec 11 21:05:46 2016 - Fold 4 
## Sun Dec 11 21:05:48 2016 - Fold 5 
## Sun Dec 11 21:05:50 2016 Repetition 5 
## Sun Dec 11 21:05:50 2016 - Fold 1 
## Sun Dec 11 21:05:52 2016 - Fold 2 
## Sun Dec 11 21:05:55 2016 - Fold 3 
## Sun Dec 11 21:05:57 2016 - Fold 4 
## Sun Dec 11 21:05:59 2016 - Fold 5 
## Sun Dec 11 21:06:01 2016 Repetition 6 
## Sun Dec 11 21:06:01 2016 - Fold 1 
## Sun Dec 11 21:06:03 2016 - Fold 2 
## Sun Dec 11 21:06:06 2016 - Fold 3 
## Sun Dec 11 21:06:09 2016 - Fold 4 
## Sun Dec 11 21:06:10 2016 - Fold 5 
## Sun Dec 11 21:06:14 2016 Done.
res.lda.sp$benchmark$runtime.performance
## Time difference of 1.211555 mins</code></pre></div>
<p>The same can be done faster using <code>parsperrorest()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res.lda.sp.par &lt;-<span class="st"> </span><span class="kw">parsperrorest</span>(fo, <span class="dt">data =</span> maipo, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;utmx&quot;</span>,<span class="st">&quot;utmy&quot;</span>), 
                                <span class="dt">model.fun =</span> lda,
                                <span class="dt">pred.fun =</span> lda.predfun, 
                                <span class="dt">pred.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>),
                                <span class="dt">smp.fun =</span> partition.factor.cv,
                                <span class="dt">smp.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>, <span class="dt">repetition =</span> <span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nfold =</span> <span class="dv">5</span>),
                                <span class="dt">par.args =</span> <span class="kw">list</span>(<span class="dt">par.units =</span> <span class="dv">2</span>, <span class="dt">par.mode =</span> <span class="dv">2</span>),
                                <span class="dt">error.rep =</span> <span class="ot">TRUE</span>, <span class="dt">error.fold =</span> <span class="ot">TRUE</span>,
                                <span class="dt">benchmark =</span> <span class="ot">TRUE</span>)
## Sun Dec 11 21:06:53 2016 Done.
res.lda.sp.par$benchmark$runtime.performance
## Time difference of 38.85616 secs</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res.lda.par &lt;-<span class="st"> </span><span class="kw">parsperrorest</span>(fo, <span class="dt">data =</span> maipo, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;utmx&quot;</span>,<span class="st">&quot;utmy&quot;</span>), 
                               <span class="dt">model.fun =</span> lda,
                               <span class="dt">pred.fun =</span> lda.predfun, 
                               <span class="dt">pred.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>),
                               <span class="dt">smp.fun =</span> partition.cv,
                               <span class="dt">smp.args =</span> <span class="kw">list</span>(<span class="dt">repetition =</span> <span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nfold =</span> <span class="dv">5</span>),
                               <span class="dt">par.args =</span> <span class="kw">list</span>(<span class="dt">par.units =</span> <span class="dv">2</span>, <span class="dt">par.mode =</span> <span class="dv">2</span>),
                               <span class="dt">error.rep =</span> <span class="ot">TRUE</span>, <span class="dt">error.fold =</span> <span class="ot">TRUE</span>,
                               <span class="dt">benchmark =</span> <span class="ot">TRUE</span>)
## Sun Dec 11 21:07:30 2016 Done.
res.lda.sp.par$benchmark$runtime.performance
## Time difference of 38.85616 secs</code></pre></div>
</div>
<div id="bagging" class="section level2">
<h2>Bagging</h2>
<p>This time we do not need to set up a custom <code>pred.fun</code> as the generic <code>predict()</code> works fine. Running <code>sperrorest()</code> takes some time here (a few minutes depending on your CPU power).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res.bagg.sp &lt;-<span class="st"> </span><span class="kw">sperrorest</span>(fo, <span class="dt">data =</span> maipo, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;utmx&quot;</span>,<span class="st">&quot;utmy&quot;</span>), 
                          <span class="dt">model.fun =</span> bagging,
                          <span class="dt">pred.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>),
                          <span class="dt">smp.fun =</span> partition.factor.cv,
                          <span class="dt">smp.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>,
                                          <span class="dt">repetition =</span> <span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nfold =</span> <span class="dv">5</span>),
                          <span class="dt">error.rep =</span> <span class="ot">TRUE</span>, <span class="dt">error.fold =</span> <span class="ot">TRUE</span>,
                          <span class="dt">benchmark =</span> <span class="ot">TRUE</span>, <span class="dt">verbose =</span> <span class="st">&quot;rep&quot;</span>)
## Sun Dec 11 21:07:30 2016 Repetition 1 
## Sun Dec 11 21:08:27 2016 Repetition 2 
## Sun Dec 11 21:09:09 2016 Repetition 3 
## Sun Dec 11 21:09:46 2016 Repetition 4 
## Sun Dec 11 21:10:29 2016 Repetition 5 
## Sun Dec 11 21:11:21 2016 Repetition 6 
## Sun Dec 11 21:11:58 2016 Done.
res.bagg.sp$benchmark$runtime.performance
## Time difference of 4.455468 mins</code></pre></div>
<p>To speed things up, we can use <code>parsperrorest()</code> and see the time difference. Note that we have two parallel modes to choose from!<br />
In this example we will use <code>par.mode = 2</code> because <code>par.mode = 1</code> will not work in this example (reason unknown). In this vignette we will always use 2 cores to ensure that this example is working for everybody.<br />
You can of course increase the number of cores and also the number of repetitions/folds to your desire! Note that we will not use any console outputs in this vignette to keep it tidy. However you can just change this setting to your desire using the <code>progress</code> argument.</p>
<div id="details-of-par.mode" class="section level4">
<h4>Details of par.mode</h4>
<p><code>par.mode = 1</code> uses either a <code>parallel::mclapply()</code> (Unix) or <code>parallel::parApply()</code> (Windows), depending on your platform. Due to this contraint this mode is not used in this vignette. So if you are reading this and running a Windows machine, jump to <code>par.mode = 2</code> or <code>par.mode = 3</code> example! The advantage of using <code>par.mode = 1</code> compared to <code>par.mode = 2</code> is its speed. However <code>par.mode = 1</code> lacks in stability.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res.bagg.sp.par &lt;-<span class="st"> </span><span class="kw">parsperrorest</span>(fo, <span class="dt">data =</span> maipo, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;utmx&quot;</span>,<span class="st">&quot;utmy&quot;</span>), 
                                 <span class="dt">model.fun =</span> bagging,
                                 <span class="dt">pred.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>),
                                 <span class="dt">smp.fun =</span> partition.factor.cv,
                                 <span class="dt">smp.args =</span> <span class="kw">list</span>(<span class="dt">fac =</span> <span class="st">&quot;field&quot;</span>, 
                                                 <span class="dt">repetition =</span> <span class="dv">1</span>:<span class="dv">6</span>, <span class="dt">nfold =</span> <span class="dv">5</span>),
                                 <span class="dt">par.args =</span> <span class="kw">list</span>(<span class="dt">par.units =</span> <span class="dv">2</span>, <span class="dt">par.mode =</span> <span class="dv">2</span>),
                                 <span class="dt">error.rep =</span> <span class="ot">TRUE</span>, <span class="dt">error.fold =</span> <span class="ot">TRUE</span>,
                                 <span class="dt">benchmark =</span> <span class="ot">TRUE</span>)
## Sun Dec 11 21:14:11 2016 Done.
res.bagg.sp.par$benchmarks$runtime.performance
## Time difference of 2.221301 mins</code></pre></div>
</div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<div id="refs" class="references">
<div id="ref-Breiman1996">
<p>Breiman, L. (1996). Bagging predictors. <em>Machine Learning</em>, <em>24</em>(2), 123â140.</p>
</div>
<div id="ref-Breiman2001">
<p>Breiman, L. (2001). Random forests. <em>Machine Learning</em>, <em>45</em>(1), 5â32.</p>
</div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
